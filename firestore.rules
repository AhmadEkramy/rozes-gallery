rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    // Helper function to check if user is admin
    function isAdmin() {
      return request.auth != null && request.auth.token.email == 'admin@rozesgallery.com';
    }
    
    // Products collection
    match /products/{productId} {
      allow read: if true;  // Anyone can read products
      allow write: if isAdmin();  // Only admin can write
    }
    
    // Special Offers collection
    match /offers/{offerId} {
      allow read: if true;  // Anyone can read offers
      allow write: if isAdmin();  // Only admin can write
    }
    
    // Cart collection
    match /cart/{userId} {
      allow read, write: if request.auth != null && request.auth.uid == userId;  // Users can only access their own cart
    }

    // Orders collection
    match /orders/{orderId} {
      allow read: if
        // Admins can read all orders
        isAdmin() ||
        // Users can read their own orders
        (request.auth != null && resource.data.userId == request.auth.uid) ||
        // Guest users can read orders they just created
        (resource.data.userId == null && resource.data.email == request.resource.data.email);
      
      allow create: if
        // Validate required order fields
        request.resource.data.customerName != null &&
        request.resource.data.email != null &&
        request.resource.data.phone != null &&
        request.resource.data.shippingAddress != null &&
        request.resource.data.products != null &&
        // Either authenticated user with matching userId or guest with null userId
        (
          (request.auth != null && request.resource.data.userId == request.auth.uid) ||
          (request.auth == null && request.resource.data.userId == null)
        );
      
      allow update, delete: if isAdmin();  // Only admin can update/delete orders
    }

    // Coupons collection
    match /coupons/{couponId} {
      allow read: if
        // Admins can read all coupons
        isAdmin() ||
        // Public users can only read active and non-expired coupons
        (
          resource.data.isActive == true &&
          resource.data.expiryDate > request.time
        );
      
      allow create, update, delete: if isAdmin();  // Only admin can manage coupons
    }
  }
}
